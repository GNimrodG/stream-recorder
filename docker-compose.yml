services:
  stream-recorder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stream-recorder
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      # Persist recordings data
      - recordings_data:/app/recordings
      # Persist database
      - db_data:/app/data
    environment:
      - NODE_ENV=production
      - RECORDINGS_DB_PATH=/app/data/recordings.json
      - RECORDINGS_OUTPUT_DIR=/app/recordings
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    networks:
      - stream-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

networks:
  stream-network:
    driver: bridge

volumes:
  recordings_data:
    driver: local
  db_data:
    driver: local

